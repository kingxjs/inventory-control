# 物品出入库登记系统（Tauri + shadcn/ui）完整规格文档 v1.5

## 1. 目标与约束

* 单机跨平台客户端（Win/macOS/Linux），本地 SQLite 持久化
* 认证：本地账号密码登录；初始化创建 `admin`，默认密码 `123456`（仅存哈希）
* 记录人：所有库存类交易必须手动选择“记录人”（可与登录用户不同）
* 审计：所有操作必须记录审计日志（成功/失败）
* 文件存储：存储根目录可在客户端修改；修改后自动迁移 `db/photos/exports/backups`
* 权限：默认 RBAC 关闭（单 Admin 全权限）；保留 Keeper/Viewer 作为可选扩展开关

---

## 2. 存储目录与迁移（强制）

### 2.1 存储根目录

* 配置键：`app_meta.storage_root`
* 默认：Tauri `app_data_dir()`
* 子目录固定：

  * `db/`：`db.sqlite`（含 WAL/SHM）
  * `photos/`：物品照片
  * `exports/`：导出文件
  * `backups/`：备份文件

### 2.2 修改存储目录（自动迁移）

* 命令：`set_storage_root({ new_path })`
* 规则（原子/可回滚）：

  1. 预检：新目录可写、空间足够；目标空或可接管；禁止敏感目录
  2. 全局写锁 + `migrating=true` 阻断其它写命令
  3. 关闭 DB 连接
  4. 迁移 `db/ photos/ exports/ backups/`（同盘 move；跨盘 copy+校验+清理）
  5. 校验：DB 文件存在；目录数量/大小一致（抽样 hash 可选）
  6. 更新 `app_meta.storage_root=new_path`
  7. 重连 DB
* 路径策略：

  * `media_attachment.file_path` 仅存相对路径 `photos/...`（历史上为物品图片的记录），迁移不需改 DB
  * 若历史为绝对路径，迁移时统一重写为相对并写审计 `MEDIA_ATTACHMENT_ITEM_PATH_REWRITE`（审计动作名已更新）
* 审计：`SYSTEM_STORAGE_ROOT_CHANGE` success/fail
* UI：迁移进度（预检/锁定/关DB/迁移/校验/更新/重连）；迁移期间禁用交易/导入导出/备份恢复

---

## 3. 角色与权限（RBAC 可选）

### 3.1 默认模式（RBAC 关闭）

* 系统仅需一个 Admin；不做权限拦截
* `operator.role` 固定 admin 或创建时隐藏 role
* 配置：`app_meta.rbac_enabled=0`

### 3.2 可选模式（RBAC 开启）

* Admin：全权限（结构/人员/物品/交易/冲正/备份恢复/设置）
* Keeper：入库/出库/移库/盘点、物品、查询导出
* Viewer：查询导出
* 配置：`app_meta.rbac_enabled=1`

---

## 4. 数据模型（PRD）

## 4.1 人员（Operator，含登录）

字段：

* `username`（唯一）
* `display_name`
* `role`（admin/keeper/viewer，默认 admin）
* `status`（active/inactive）
* `password_hash`（NOT NULL，Argon2id/Bcrypt）
* `must_change_pwd`（0/1，默认 1）
* `pwd_changed_at`（可空）
* `created_at`

初始化：

* 若无人员：创建 `admin`，默认密码 `123456`（哈希存储），`must_change_pwd=1`

## 4.2 货架结构

### Rack

* `code`（唯一）
* `name`
* `status`（active/inactive）
* `level_count`（>=1）
* `slots_per_level`（>=1）
* `created_at`

### Slot

* `rack_id`
* `level_no`（>=1）
* `slot_no`（>=1）
* `code`（全局唯一，默认 `R{rack_code}-L{level}-S{slot_padded}`）
* `status`
* `created_at`

## 4.3 物品（Item）

字段：

* `item_code`（唯一）
* `name`
* `model`（设备型号）
* `spec`（可选）
* `uom`（可选）
* `status`
* `remark`
* `created_at`

### 媒体附件 / 物品照片（多张）

* 文件落地：`{storage_root}/photos/{item_id}/{uuid}.{ext}`（物品图片仍建议按 `item_id` 目录组织）
* 表：`media_attachment`（通用附件表，type 字段区分用途；物品图片使用 `type='item'` 且 `data_id` 存放 `item_id`）

  * `id`（主键 UUID）
  * `type`（附件用途，例如 `item`、`txn` 等）
  * `data_id`（关联实体 id，例如 `item_id` 或 `txn_id`）
  * `file_path`（相对路径）
  * `mime`
  * `sort_no`
  * `created_at`

## 4.4 交易流水（Txn，事实表）

* `txn_no`（唯一，可读）
* `type`：IN/OUT/MOVE/COUNT/ADJUST/REVERSAL
* `occurred_at`（业务时间）
* `created_at`（记录时间）
* `operator_id`（记录人，手动选择，必填）
* `item_id`（必填）
* `from_slot_id`（OUT/MOVE/ADJUST/COUNT）
* `to_slot_id`（IN/MOVE）
* `qty`（整数；IN/OUT/MOVE 为正；ADJUST 可正可负；COUNT 通常为0）
* `actual_qty`（COUNT 实际数，>=0）
* `ref_txn_id`（REVERSAL 指向被冲正流水）
* `note`

## 4.5 库存（Stock，缓存表）

* `item_id + slot_id` 唯一
* `qty`（>=0）
* `updated_at`

## 4.6 审计日志（Audit Log，强制）

* `actor_operator_id`（当前登录用户）
* `action`（枚举字符串）
* `target_type`（operator/item/rack/slot/txn/system 等）
* `target_id`（实体id或txn_no）
* `request_json`（脱敏后参数）
* `result`（success/fail）
* `error_code`（可空）
* `error_detail`（可空，截断）
* `created_at`

---

## 5. 业务流程与校验（PRD）

## 5.1 登录/改密

* 登录：校验 password_hash；成功写审计 `AUTH_LOGIN`
* 首次登录：`must_change_pwd=1` 强制改密；成功写 `AUTH_CHANGE_PASSWORD` 并置 0
* 审计脱敏：password/new_password 不写入 request_json

## 5.2 入库（IN）

输入：item、to_slot、qty>0、occurred_at、记录人、note
校验：item/slot/operator active；qty为正整数
事务：insert txn(IN)；stock += qty
审计：`TXN_INBOUND` success/fail

## 5.3 出库（OUT）

校验：stock(item,from_slot) >= qty
事务：insert txn(OUT)；stock -= qty
审计：`TXN_OUTBOUND`

## 5.4 移库（MOVE）

校验：from!=to；stock(from) >= qty；两端 slot active
事务：insert txn(MOVE)；from-=qty；to+=qty
审计：`TXN_MOVE`

## 5.5 盘点（COUNT + ADJUST 推荐）

输入：actual_qty>=0
delta=actual-current
事务：insert txn(COUNT, actual_qty)；insert txn(ADJUST, qty=delta)；set stock=actual
审计：`TXN_COUNT`

## 5.6 冲正（REVERSAL）

* 不允许删除/修改历史 txn；仅允许冲正
* ref_txn 不允许重复冲正（唯一索引）
* 反向库存影响需保证不负
  审计：`TXN_REVERSAL`

## 5.7 结构停用

* rack/slot 停用前必须库存为0（否则拒绝）
  审计：`RACK_UPDATE` / `SLOT_UPDATE`

---

## 6. 页面与交互规格（shadcn/ui）

页面：

* 登录页（admin/123456）+ 首次强制改密弹窗
* Dashboard
* 货架结构（Rack 列表 + SlotGrid + Slot详情）
* 物品管理（含照片上传/排序/删除/预览）
* 库存管理（按货架/按物品）
  - 入库/出库/移库/盘点/冲正（均含“记录人”选择）
* 流水查询（过滤/详情/冲正链路）
* 人员管理
* 操作日志（审计查询/详情/导出）
* 系统设置（RBAC开关、存储目录迁移、导入导出、备份恢复）

表单强制字段：

* 所有交易：记录人、occurred_at、item、slot（或 from/to）、qty/actual_qty、note

---

# 开发文档（Engineering Spec）
开发过程，需要补全注释、类型定义、API 文档等

## 7. 技术架构

* Tauri 2
* 前端：React + TypeScript + shadcn/ui + TanStack Table + React Hook Form + Zod
* 后端：Rust + sqlx(SQLite) + migrations
* 并发写：Rust 全局 `Mutex` + SQLite `BEGIN IMMEDIATE`
* 文件操作：Rust 负责复制/移动/删除与校验；前端仅触发与展示进度

---

## 8. 数据库 DDL（SQLite）

```sql
PRAGMA foreign_keys = ON;

CREATE TABLE IF NOT EXISTS app_meta (
  k TEXT PRIMARY KEY,
  v TEXT NOT NULL
);

CREATE TABLE IF NOT EXISTS operator (
  id TEXT PRIMARY KEY,
  username TEXT NOT NULL UNIQUE,
  display_name TEXT NOT NULL,
  role TEXT NOT NULL CHECK(role IN ('admin','keeper','viewer')),
  status TEXT NOT NULL DEFAULT 'active' CHECK(status IN ('active','inactive')),
  password_hash TEXT NOT NULL,
  must_change_pwd INTEGER NOT NULL DEFAULT 1 CHECK(must_change_pwd IN (0,1)),
  pwd_changed_at INTEGER,
  created_at INTEGER NOT NULL
);

CREATE TABLE IF NOT EXISTS rack (
  id TEXT PRIMARY KEY,
  code TEXT NOT NULL UNIQUE,
  name TEXT NOT NULL,
  status TEXT NOT NULL DEFAULT 'active' CHECK(status IN ('active','inactive')),
  level_count INTEGER NOT NULL,
  slots_per_level INTEGER NOT NULL,
  created_at INTEGER NOT NULL
);

CREATE TABLE IF NOT EXISTS slot (
  id TEXT PRIMARY KEY,
  rack_id TEXT NOT NULL REFERENCES rack(id),
  level_no INTEGER NOT NULL,
  slot_no INTEGER NOT NULL,
  code TEXT NOT NULL UNIQUE,
  status TEXT NOT NULL DEFAULT 'active' CHECK(status IN ('active','inactive')),
  created_at INTEGER NOT NULL,
  UNIQUE(rack_id, level_no, slot_no)
);

CREATE INDEX IF NOT EXISTS idx_slot_rack_level ON slot(rack_id, level_no, slot_no);

CREATE TABLE IF NOT EXISTS item (
  id TEXT PRIMARY KEY,
  item_code TEXT NOT NULL UNIQUE,
  name TEXT NOT NULL,
  model TEXT,
  spec TEXT,
  uom TEXT,
  status TEXT NOT NULL DEFAULT 'active' CHECK(status IN ('active','inactive')),
  remark TEXT,
  created_at INTEGER NOT NULL
);

CREATE INDEX IF NOT EXISTS idx_item_name ON item(name);
CREATE INDEX IF NOT EXISTS idx_item_model ON item(model);

CREATE TABLE IF NOT EXISTS media_attachment (
  id TEXT PRIMARY KEY,
  type TEXT NOT NULL,
  data_id TEXT NOT NULL,
  file_path TEXT NOT NULL,
  mime TEXT,
  sort_no INTEGER NOT NULL DEFAULT 0,
  created_at INTEGER NOT NULL
);

CREATE INDEX IF NOT EXISTS idx_media_attachment_data_sort ON media_attachment(type, data_id, sort_no);

CREATE TABLE IF NOT EXISTS txn (
  id TEXT PRIMARY KEY,
  txn_no TEXT NOT NULL UNIQUE,
  type TEXT NOT NULL CHECK(type IN ('IN','OUT','MOVE','COUNT','ADJUST','REVERSAL')),
  occurred_at INTEGER NOT NULL,
  created_at INTEGER NOT NULL,
  operator_id TEXT NOT NULL REFERENCES operator(id),
  item_id TEXT NOT NULL REFERENCES item(id),
  from_slot_id TEXT REFERENCES slot(id),
  to_slot_id TEXT REFERENCES slot(id),
  qty INTEGER NOT NULL,
  actual_qty INTEGER,
  ref_txn_id TEXT REFERENCES txn(id),
  note TEXT
);

CREATE UNIQUE INDEX IF NOT EXISTS uq_reversal_ref
ON txn(ref_txn_id) WHERE type='REVERSAL';

CREATE INDEX IF NOT EXISTS idx_txn_item_time ON txn(item_id, occurred_at);
CREATE INDEX IF NOT EXISTS idx_txn_type_time ON txn(type, occurred_at);
CREATE INDEX IF NOT EXISTS idx_txn_from_slot ON txn(from_slot_id);
CREATE INDEX IF NOT EXISTS idx_txn_to_slot ON txn(to_slot_id);

CREATE TABLE IF NOT EXISTS stock (
  id TEXT PRIMARY KEY,
  item_id TEXT NOT NULL REFERENCES item(id),
  slot_id TEXT NOT NULL REFERENCES slot(id),
  qty INTEGER NOT NULL,
  updated_at INTEGER NOT NULL,
  UNIQUE(item_id, slot_id)
);

CREATE INDEX IF NOT EXISTS idx_stock_slot ON stock(slot_id);
CREATE INDEX IF NOT EXISTS idx_stock_item ON stock(item_id);

CREATE TABLE IF NOT EXISTS audit_log (
  id TEXT PRIMARY KEY,
  created_at INTEGER NOT NULL,
  actor_operator_id TEXT REFERENCES operator(id),
  action TEXT NOT NULL,
  target_type TEXT,
  target_id TEXT,
  request_json TEXT,
  result TEXT NOT NULL CHECK(result IN ('success','fail')),
  error_code TEXT,
  error_detail TEXT
);

CREATE INDEX IF NOT EXISTS idx_audit_time ON audit_log(created_at);
CREATE INDEX IF NOT EXISTS idx_audit_actor_time ON audit_log(actor_operator_id, created_at);
CREATE INDEX IF NOT EXISTS idx_audit_action_time ON audit_log(action, created_at);
```

初始化：

* operator 为空：插入 admin（hash(123456)，must_change_pwd=1）
* `app_meta.rbac_enabled=0`
* `app_meta.storage_root=<default_appdata_path>`

---

## 9. 审计日志实现规范

* 覆盖所有 tauri commands：认证、人员、结构、物品、照片、交易、查询（至少导出相关）、导入导出、备份恢复、设置、存储迁移
* 入口拦截：统一 wrapper

  * 获取 actor（session）
  * 参数脱敏（password 字段置空/剔除）
  * 捕获 success/fail 与 error_code/detail
  * 写入 `audit_log`（业务写同事务；业务失败也写 fail）

action 建议集合：

* `AUTH_LOGIN`, `AUTH_LOGOUT`, `AUTH_CHANGE_PASSWORD`, `AUTH_RESET_PASSWORD`
* `OPERATOR_CREATE/UPDATE/STATUS`
* `RACK_CREATE/UPDATE/STATUS`, `SLOT_REGEN/STATUS`
* `ITEM_CREATE/UPDATE/STATUS`, `ITEM_IMPORT/EXPORT`
* `MEDIA_ATTACHMENT_ITEM_ADD/REMOVE/REORDER`（物品图片相关审计动作，后台统一存储在 `media_attachment` 表，type='item'）
* `TXN_INBOUND/OUTBOUND/MOVE/COUNT/REVERSAL`
* `SYSTEM_SETTINGS_UPDATE`, `SYSTEM_STORAGE_ROOT_CHANGE`, `DB_BACKUP/RESTORE`
* `AUDIT_EXPORT`

---

## 10. Tauri Commands（接口清单）

认证：

* `login({username,password}) -> {actor_operator_id, must_change_pwd}`
* `change_password({actor_operator_id, old_password, new_password})`
* `reset_operator_password({id, new_password})`（Admin）

设置/存储：

* `get_settings() -> {rbac_enabled, storage_root, slot_no_pad?, low_stock_threshold?}`
* `set_settings({rbac_enabled?, slot_no_pad?, low_stock_threshold?})`
* `set_storage_root({new_path}) -> {stage, progress}`（或事件推送）

人员：

* `list_operators({status?})`
* `create_operator({username,display_name,role?,password,status?})`
* `update_operator({id,display_name,role?,status?})`
* `set_operator_status({id,status})`

结构：

* `create_rack({code,name,level_count,slots_per_level})`
* `update_rack({id,...})`
* `set_rack_status({id,status})`
* `regenerate_slots({rack_id})`（库存为0前提）
* `list_racks()` / `list_slots({rack_id,level_no?})`

物品/照片：

* `create_item/update_item/set_item_status/search_items/import_items/export_items`
* `add_item_photos({item_id, src_paths[]})`  // 操作将写入 `media_attachment`（type='item'）
* `list_item_photos({item_id})`             // 从 `media_attachment` 中读取 type='item' 的记录
* `remove_item_photo({photo_id})`           // 删除 `media_attachment` 中对应记录
* `reorder_item_photos({item_id, photo_ids_in_order[]})` // 在 `media_attachment` 上调整 sort_no

交易：

* `create_inbound({item_code,to_slot_code,qty,occurred_at,operator_username,note?})`
* `create_outbound({item_code,from_slot_code,qty,occurred_at,operator_username,note?})`
* `create_move({item_code,from_slot_code,to_slot_code,qty,occurred_at,operator_username,note?})`
* `create_count({item_code,slot_code,actual_qty,occurred_at,operator_username,note?})`
* `reverse_txn({txn_no,occurred_at,operator_username,note?})`

查询/导出/备份/审计：

* `list_stock_by_slot/list_stock_by_item/list_txns`
* `export_stock/export_txns`
* `backup_db/restore_db`
* `list_audit_logs/export_audit_logs`

---

## 11. 项目结构（实际）

```
/ (仓库根)
  .git/
  README.md
  package.json
  pnpm-lock.yaml
  tsconfig.json
  vite.config.ts
  components.json
  .react-router/
  .vscode/
  app/                # 前端源代码（React + TypeScript + shadcn/ui）
    app.css
    root.tsx
    routes.ts
    components/
      auth/
      common/
      layout/
      stock/
      ui/
    lib/               # 前端工具封装（invoke/zod/utils 等）
    routes/
    welcome/
  build/              # Vite 打包产物（client/ 下静态资源）
  docs/               # 文档（此处为规格文档）
    完整规格文档.updated.md
  public/             # 静态资源（splashscreen 等）
  scripts/            # 辅助脚本（证书/同步等）
  src-tauri/          # 原生部分：Rust 源码、tauri 配置、migrations
    Cargo.toml
    tauri.conf.json
    build.rs
    src/
      main.rs
      state.rs
      api/
      domain/
      repo/
      services/
      infra/
      migrations/
```

- **说明**：以上为当前仓库实际目录摘要（已在磁盘验证）。

### 更细粒度：文件树（摘录）

```
app/
  app.css
  root.tsx
  routes.ts
  routes/
    _layout.tsx
    operators.tsx
    audit.tsx
    stock.tsx
    guard.tsx
    racks.tsx
    home.tsx
    items.tsx
    warehouses.tsx
    dashboard.tsx
    login.tsx
    txns.tsx
    settings.tsx
  lib/
    auth.ts
    credentials.ts
    tauri.ts
    utils.ts
  components/
    auth/
      force-change-password-dialog.tsx
    common/
      image-picker.tsx
      confirm-button.tsx
      combobox.tsx
      common-dialogs.tsx
      page-header.tsx
      pickers/
        warehouse-picker.tsx
        item-picker.tsx
        slot-cascader-picker.tsx
        slot-picker.tsx
        rack-picker.tsx
        operator-picker.tsx
    layout/
      app-shell.tsx
    stock/
      stock-action-dialogs.tsx
      types.ts
      helpers.ts
      forms/
        inbound-form.tsx
        outbound-form.tsx
        move-form.tsx
        reversal-form.tsx
        count-form.tsx
    ui/
      chart.tsx
      command.tsx
      calendar.tsx
      tooltip.tsx
      sonner.tsx
      label.tsx
      popover.tsx
      input-group.tsx
      card.tsx
      tabs.tsx
      pagination.tsx
      alert-dialog.tsx
      date-time-picker.tsx
      form.tsx
      input.tsx
      textarea.tsx
      select.tsx
      dropdown-menu.tsx
      button.tsx
      table.tsx
      badge.tsx
      dialog.tsx
      date.tsx
  welcome/
    welcome.tsx
    logo-dark.svg
    logo-light.svg

src-tauri/src/
  main.rs
  lib.rs
  state.rs
  api/
    auth_cmd.rs
    app_cmd.rs
    operator_cmd.rs
    rack_cmd.rs
    item_cmd.rs
    photo_cmd.rs
    audit_cmd.rs
    txn_cmd.rs
    stock_cmd.rs
    warehouse_cmd.rs
    dashboard_cmd.rs
    system_cmd.rs
    data_cmd.rs
    paging.rs
    command_guard.rs
    mod.rs
  domain/
    mod.rs
    errors.rs
    audit.rs
  services/
    mod.rs
    auth_service.rs
    operator_service.rs
    rack_service.rs
    item_service.rs
    photo_service.rs
    txn_service.rs
    stock_service.rs
    audit_service.rs
    system_service.rs
    import_export_service.rs
    dashboard_service.rs
    warehouse_service.rs
    permission_service.rs
  repo/
    mod.rs
    operator_repo.rs
    rack_repo.rs
    item_repo.rs
    photo_repo.rs
    txn_repo.rs
    stock_repo.rs
    stock_query_repo.rs
    warehouse_repo.rs
    meta_repo.rs
    audit_repo.rs
    dashboard_repo.rs
  infra/
    mod.rs
    db.rs
    fs.rs
    crypto.rs

```

（以上为摘录，若需完整逐文件列出我可继续生成包含每个子目录下所有文件的完整树，并替换本节。）


---

## 12. 错误码

* `AUTH_FAILED`, `PWD_CHANGE_REQUIRED`
* `VALIDATION_ERROR`, `NOT_FOUND`, `INACTIVE_RESOURCE`
* `INSUFFICIENT_STOCK`, `CONFLICT`, `FORBIDDEN`
* `DB_ERROR`, `IO_ERROR`

---

## 13. 验收用例

* 首次启动：生成 admin；admin/123456 登录→强制改密
* 创建人员/货架/物品；物品上传多张照片并排序
* 入库/出库/移库/盘点/冲正：均需选择记录人；库存正确；冲正不可重复
* 操作日志：每个动作（含失败）可查询；导出日志
* 修改存储目录：自动迁移 DB/照片/导出/备份；迁移后照片与数据可用；失败可回滚
* RBAC 开启：Keeper/Viewer 权限正确拦截

---

## 附录：项目扫描（2026-01-22）

- **概览**：本仓库为 Tauri + React 的桌面客户端项目，包含前端、Tauri 原生 Rust 代码、构建产物与文档。主要目录见下。
- **关键目录**：
  - `app/`：前端源代码（TypeScript + React + shadcn/ui），包含 `routes/`、`components/`、`lib/` 等。
  - `src-tauri/`：Rust 源码与 Tauri 配置，含 `src/`、`migrations/`、`Cargo.toml`、`tauri.conf.json`。
  - `build/`：Vite 打包输出（client/ 下为前端静态产物）。
  - `public/`：静态资源（如 splashscreen.html）。
  - `scripts/`：辅助脚本（证书、同步等）。
  - `docs/`：项目相关规格与文档（当前文件位于此处）。
  - 其他：根目录包含 `package.json`、`pnpm-lock.yaml`、`vite.config.ts`、`tsconfig.json` 等配置文件。

- **前端要点**：采用 React + TypeScript，组件按功能域组织（auth、items、stock、ui 等），`app/routes` 包含页面路由实现；UI 采用 shadcn/ui 风格组件。
- **原生/后端要点**：`src-tauri/src/` 实现了 tauri commands、数据库（sqlx + SQLite）、文件系统操作与审计封装；`migrations/` 包含数据库迁移 SQL 文件。
- **构建/运行**：使用 `pnpm` + `vite` 前端，Tauri 结合 Rust 进行打包与原生能力接入；开发时常用命令示例建议写入 docs（如 `pnpm install`、`pnpm tauri dev`、`pnpm build`）。

- **建议 / 待办（可选）**：
  - 在文档顶部或末尾写明“最后更新日期”和 `package.json` 中的项目版本号，便于追踪更新。
  - 增加一节“本地开发与构建”指出常用命令与依赖安装步骤，帮助新开发者快速上手。
  - 将 docs 下补充一页“关键路径与启动步骤”，并在 README 中加链接。
